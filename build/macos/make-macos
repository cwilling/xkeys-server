#!/bin/bash


# Create an installable macos package
# We assume nodejs/npm installation already exists

PKG_VERSION=$(python3 -c 'import json,sys; f=open("../../package.json"); obj=json.load(f);print(obj["version"])')
echo "PACKAGE VERSION = $PKG_VERSION"

# Work in the correct directory
cd $(dirname $0)
CWD=$(pwd)

set -e

# Clean out previous runs
#
rm -rf target
rm -rf application
mkdir application

# Use pkg to generate single executable
( cd ../.. && npx pkg . )

# Copy what we want packaged into "application" directory
cp -a ../../dist/xkeys-server-macos-arm64 application/

# Build the package - pass the project name & version number
./build-macos.sh xkeys-server $PKG_VERSION

[ "$?" ] &&  echo "Package sould be available at ${CWD}/target/pkg-signed/xkeys-server-macos-installer-"$(uname -m)"-${PKG_VERSION}.pkg"
