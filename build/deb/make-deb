#!/bin/bash


# Create a .deb package for xkeys-server
# Requires args $1 = VERSION
#               $2 = ARCH

[ $# -ne 1 ] && {
	echo "Need ARCH arg to proceed."
	echo "Exiting now ..."
	exit 1
}
#VERSION=$1
VERSION=$(python3 -c 'import json,sys; f=open("../../package.json"); obj=json.load(f);print(obj["version"])')
ARCH=$1
if [ "${ARCH}" = "x86_64" ]; then
  PKGARCH=amd64
else
  PKGARCH=${ARCH}
fi

# Work in the correct directory
cd $(dirname $0)
CWD=$(pwd)

# Bundle the executable
( cd ../.. ; pkg . )

# Do we have the "executable"?
[ -x ../../dist/xkeys-server-linux ] || {
	echo "Can't find xkeys-server-linux to package"
	echo "Exiting now ..."
	exit 2
}

# Create the package shell
rm -rf xkeys-server-${VERSION}_${PKGARCH}
mkdir -p xkeys-server-${VERSION}_${PKGARCH}/etc/systemd/system
mkdir -p xkeys-server-${VERSION}_${PKGARCH}/lib/udev/rules.d
mkdir -p xkeys-server-${VERSION}_${PKGARCH}/usr/bin
mkdir -p xkeys-server-${VERSION}_${PKGARCH}/DEBIAN

sed -e "s/%ARCH%/${ARCH}/" -e "s/%NOGROUP%/nogroup/" ../xkeys-server.service > xkeys-server-${VERSION}_${PKGARCH}/etc/systemd/system/xkeys-server.service
cp -p ../50-xkeys.rules xkeys-server-${VERSION}_${PKGARCH}/lib/udev/rules.d/
cp -p ../../dist/xkeys-server-linux xkeys-server-${VERSION}_${PKGARCH}/usr/bin/

sed -e "s/%VERSION%/${VERSION}/g" control.template >xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/control
sed -e "s/%ARCH%/${ARCH}/" postinst > xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/postinst
chmod a+x xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/postinst
cat <<EOF > xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/prerm
#!/bin/sh
systemctl stop xkeys-server
systemctl disable xkeys-server
systemctl daemon-reload
exit 0
EOF
chmod a+x xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/prerm
cat <<EOF > xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/postrm
#!/bin/sh
udevadm control --reload-rules
udevadm trigger
exit 0
EOF
chmod a+x xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/postrm

# Insert size
pkg_size=$(du -s xkeys-server-${VERSION}_${PKGARCH} | cut -f1)
sed -i -e "s/%SIZE%/${pkg_size}/g" xkeys-server-${VERSION}_${PKGARCH}/DEBIAN/control

# Create the .deb package
dpkg-deb --build --root-owner-group xkeys-server-${VERSION}_${PKGARCH}

echo "The package is at ${CWD}/xkeys-server-${VERSION}_${PKGARCH}.deb"

